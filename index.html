<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control Panel</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10; --text:#f2f3f5; --muted:#b9bcc6; --line:#242838;
      --accent:#a46b8a; --btn:#171a24; --btn2:#1c2030; --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:
      radial-gradient(1000px 600px at 50% 10%, rgba(164,107,138,.18), transparent 60%),
      radial-gradient(900px 600px at 50% 120%, rgba(107,138,164,.10), transparent 60%),
      var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:28px 18px 42px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0;font-weight:600}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .ghost{background:transparent;border:1px solid var(--line);color:var(--muted);
      padding:10px 12px;border-radius:14px;cursor:pointer}
    .ghost:hover{border-color:#323754;color:var(--text)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .title{font-size:14px;color:var(--muted);margin-bottom:8px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .pillgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}
    .pill{background:var(--btn);border:1px solid var(--line);border-radius:16px;padding:14px;cursor:pointer;text-align:left;transition:.12s}
    .pill:hover{transform:translateY(-1px);border-color:#343a55;background:var(--btn2)}
    .pill.active{border-color:rgba(164,107,138,.8);box-shadow:0 0 0 3px rgba(164,107,138,.15)}
    .pill .k{font-size:14px;font-weight:600}
    .pill .h{font-size:12px;color:var(--muted);margin-top:3px}
    .stack{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type=text]{width:100%;background:#0f1117;border:1px solid var(--line);color:var(--text);
      padding:12px;border-radius:14px;outline:none}
    .btn{background:linear-gradient(180deg,rgba(164,107,138,.25),rgba(164,107,138,.10));
      border:1px solid rgba(164,107,138,.55);color:var(--text);padding:12px 14px;border-radius:14px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--btn);border:1px solid var(--line)}
    .btn.secondary:hover{border-color:#343a55}
    .small{font-size:12px;color:var(--muted)}
    .result{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:var(--r);padding:16px}
    .result h2{font-size:13px;color:var(--muted);letter-spacing:.12em;margin:0 0 10px}
    .main{white-space:pre-line;font-size:16px;margin-bottom:10px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;font-size:14px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.10)}
    .k{color:var(--muted)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(17,19,26,.92);
      border:1px solid var(--line);padding:10px 12px;border-radius:14px;font-size:13px;display:none}
    .error{display:none;border:1px solid rgba(194,93,106,.55);background:rgba(194,93,106,.08);padding:10px 12px;border-radius:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Control Panel</h1>
        <div class="sub">Sehr intim · weich präsent · minimal</div>
      </div>
      <button class="ghost" id="btnReload">Daten neu laden</button>
    </header>

    <div class="card stack">
      <div class="stack" id="stepMode">
        <div class="title">Was möchtest du festlegen?</div>
        <div class="pillgrid" id="modeGrid"></div>
      </div>

      <div class="sep"></div>

      <div class="stack" id="stepBereich" style="display:none;">
        <div class="title">Bereich wählen</div>
        <div class="pillgrid" id="bereichGrid"></div>
      </div>

      <div class="sep" id="sep2" style="display:none;"></div>

      <div class="stack" id="stepItem" style="display:none;">
        <div class="title">Auswahl</div>
        <div class="pillgrid" id="itemGrid"></div>
      </div>

      <div class="sep" id="sep3" style="display:none;"></div>

      <div class="stack" id="stepParams" style="display:none;">
        <div class="title">Rahmen festlegen</div>

        <div class="stack" id="dauerBlock">
          <div class="small">Dauer (frei):</div>
          <input type="text" id="inpDauer" placeholder="z.B. 20Min, 2×, heute Abend, 1h" />
        </div>

        <div class="stack" id="orgBlock" style="margin-top:6px;">
          <div class="small">Orgasmus:</div>
          <div class="row">
            <button class="btn secondary" id="orgNo">Nicht gestattet</button>
            <button class="btn secondary" id="orgYes">Gestattet</button>
          </div>
          <div id="orgSub" style="display:none; margin-top:8px;">
            <div class="small">Wenn gestattet, dann:</div>
            <div class="row" style="margin-top:6px;">
              <button class="btn secondary" data-orgsub="Mit Bildnachweis">Mit Bildnachweis</button>
              <button class="btn secondary" data-orgsub="Ohne wegwischen">Ohne wegwischen</button>
              <button class="btn secondary" data-orgsub="Mit Aufnahme">Mit Aufnahme</button>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnBuild">Aufgabe erstellen</button>
          <button class="btn secondary" id="btnReset">Zurücksetzen</button>
        </div>
      </div>

      <div class="stack" id="stepResult" style="display:none;">
        <div class="result">
          <h2>DEINE AUFGABE</h2>
          <div class="main" id="resultMain"></div>
          <div class="kv" id="resultKV"></div>
        </div>
        <div class="row">
          <button class="btn" id="btnCopy">Kopieren</button>
          <button class="btn secondary" id="btnNew">Neue Auswahl</button>
        </div>
        <div class="small">Das Tool liefert Struktur. Die persönliche Ansprache kommt von dir.</div>
      </div>

      <div id="errBox" class="error"></div>
    </div>
  </div>

  <div class="toast" id="toast">Kopiert.</div>

<script>
let DATA=[], mode=null, bereich=null, selection=[], currentType=null;
let orgasmAllowed=null, orgasmRule="";
const $=id=>document.getElementById(id);

function setError(msg){
  const b=$("errBox");
  if(!msg){b.style.display="none";b.textContent="";return;}
  b.style.display="block";b.textContent=msg;
}
function showToast(msg){
  const t=$("toast"); t.textContent=msg||"Kopiert."; t.style.display="block";
  setTimeout(()=>t.style.display="none",1200);
}

async function loadCSV(){
  const res = await fetch("control_panel.csv",{cache:"no-store"});
  if(!res.ok) throw new Error("control_panel.csv nicht gefunden (muss im selben Ordner liegen).");
  const text = await res.text();
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const header = lines.shift();
  const sep = header.includes(";") ? ";" : ",";
  const cols = header.split(sep).map(s=>s.trim().toLowerCase());
  const idx = {typ:cols.indexOf("typ"),bereich:cols.indexOf("bereich"),titel:cols.indexOf("titel"),dauer:cols.indexOf("dauer"),orgasmus:cols.indexOf("orgasmus")};
  if(Object.values(idx).some(v=>v<0)) throw new Error("CSV-Header erwartet: typ;bereich;titel;dauer;orgasmus");
  DATA = lines.map(line=>{
    const p=line.split(sep).map(x=>(x??"").trim());
    return {typ:p[idx.typ],bereich:p[idx.bereich],titel:p[idx.titel],
      dauer:(p[idx.dauer]||"").toLowerCase()==="true", orgasmus:(p[idx.orgasmus]||"").toLowerCase()==="true"};
  }).filter(r=>r.typ && r.bereich && r.titel);
}

function renderModes(){
  const g=$("modeGrid"); g.innerHTML="";
  const modes=[{k:"Aufgabe",h:"Handlung / Verhalten"},{k:"Kleidung",h:"Erscheinung / Symbolik"},{k:"Kombination",h:"Kleidung + Aufgabe"}];
  for(const m of modes){
    const b=document.createElement("button");
    b.className="pill"+(mode===m.k?" active":"");
    b.innerHTML=`<div class="k">${m.k}</div><div class="h">${m.h}</div>`;
    b.onclick=()=>selectMode(m.k);
    g.appendChild(b);
  }
}

function resetAll(){
  mode=null; bereich=null; selection=[]; currentType=null;
  orgasmAllowed=null; orgasmRule=""; $("inpDauer").value="";
  ["stepBereich","stepItem","stepParams","stepResult","sep2","sep3"].forEach(id=>$(id).style.display="none");
  $("orgSub").style.display="none";
  document.querySelectorAll('[data-orgsub]').forEach(b=>b.classList.remove("active"));
  $("orgNo").classList.remove("active"); $("orgYes").classList.remove("active");
  setError(null);
  renderModes();
}

function selectMode(m){
  mode=m; selection=[]; bereich=null;
  currentType = (mode==="Kombination") ? "Kleidung" : mode;
  $("stepBereich").style.display="block";
  ["stepItem","stepParams","stepResult","sep2","sep3"].forEach(id=>$(id).style.display="none");
  setError(null);
  renderModes(); renderBereiche();
}

function renderBereiche(){
  const g=$("bereichGrid"); g.innerHTML="";
  const t = (mode==="Kombination") ? currentType : mode;
  const bereiche=[...new Set(DATA.filter(r=>r.typ===t).map(r=>r.bereich))].sort((a,b)=>a.localeCompare(b,"de"));
  for(const bch of bereiche){
    const b=document.createElement("button");
    b.className="pill"+(bereich===bch?" active":"");
    b.innerHTML=`<div class="k">${bch}</div><div class="h">${t}</div>`;
    b.onclick=()=>{bereich=bch; renderBereiche(); renderItems();};
    g.appendChild(b);
  }
}

function toggleSelection(it){
  const i=selection.findIndex(s=>s.typ===it.typ && s.bereich===it.bereich && s.titel===it.titel);
  if(i>=0) selection.splice(i,1); else selection.push(it);
  renderItems();
}

function computeNeeds(){
  return {dauer:selection.some(s=>s.dauer), org:selection.some(s=>s.orgasmus)};
}

function renderParamVisibility(){
  const n=computeNeeds();
  $("dauerBlock").style.display = n.dauer ? "block":"none";
  $("orgBlock").style.display = n.org ? "block":"none";
  if(!n.org){
    orgasmAllowed=null; orgasmRule="";
    $("orgSub").style.display="none";
    $("orgNo").classList.remove("active"); $("orgYes").classList.remove("active");
    document.querySelectorAll('[data-orgsub]').forEach(b=>b.classList.remove("active"));
  }
}

function renderItems(){
  $("sep2").style.display="block";
  $("stepItem").style.display="block";
  $("stepParams").style.display="block";
  $("stepResult").style.display="none";
  $("itemGrid").innerHTML="";
  const t=(mode==="Kombination")?currentType:mode;
  const items=DATA.filter(r=>r.typ===t && r.bereich===bereich);
  for(const it of items){
    const sel=selection.some(s=>s.typ===it.typ && s.bereich===it.bereich && s.titel===it.titel);
    const b=document.createElement("button");
    b.className="pill"+(sel?" active":"");
    b.innerHTML=`<div class="k">${it.titel}</div><div class="h">${it.typ} · ${it.bereich}</div>`;
    b.onclick=()=>toggleSelection(it);
    $("itemGrid").appendChild(b);
  }
  $("sep3").style.display="block";
  renderParamVisibility();
  if(mode==="Kombination") setError(`Kombination: erst ${currentType}. 1–2 wählen, dann „Aufgabe erstellen“.`);
  else setError(null);
}

function buildResult(){
  setError(null);
  if(selection.length===0){setError("Bitte mindestens eine Auswahl treffen."); return;}

  if(mode==="Kombination" && currentType==="Kleidung"){
    currentType="Aufgabe"; bereich=null;
    renderBereiche();
    ["stepItem","stepParams","sep2","sep3"].forEach(id=>$(id).style.display="none");
    setError("Jetzt Aufgabe wählen. Kleidung bleibt gespeichert.");
    return;
  }
  if(mode==="Kombination"){
    const hasK=selection.some(s=>s.typ==="Kleidung"), hasA=selection.some(s=>s.typ==="Aufgabe");
    if(!hasK || !hasA){setError("Für Kombination braucht es mindestens 1 Kleidung und 1 Aufgabe."); return;}
  }

  const n=computeNeeds();
  const dauerVal = n.dauer ? $("inpDauer").value.trim() : "";
  if(n.dauer && !dauerVal){setError("Bitte eine Dauer eingeben (frei)."); return;}
  if(n.org && orgasmAllowed===null){setError("Bitte Orgasmus-Regel wählen."); return;}
  if(n.org && orgasmAllowed===True && !orgasmRule){setError("Bitte Regel wählen."); return;}
  // JS True typo safe:
  if(n.org && orgasmAllowed===true && !orgasmRule){setError("Bitte Regel wählen (Bildnachweis / ohne wegwischen / Aufnahme)."); return;}

  const lines = selection.slice().sort((a,b)=>{
    const o=x=>x.typ==="Kleidung"?0:1;
    return o(a)-o(b) || a.bereich.localeCompare(b.bereich,"de") || a.titel.localeCompare(b.titel,"de");
  }).map(s=>s.titel);

  $("resultMain").textContent = lines.join("\n");
  const kv=[];
  if(n.dauer) kv.push(["Dauer", dauerVal]);
  if(n.org){
    kv.push(["Orgasmus", orgasmAllowed ? "Gestattet":"Nicht gestattet"]);
    if(orgasmAllowed) kv.push(["Regel", orgasmRule]);
  }
  const kvEl=$("resultKV"); kvEl.innerHTML="";
  for(const [k,v] of kv){
    const k1=document.createElement("div"); k1.className="k"; k1.textContent=k+":";
    const v1=document.createElement("div"); v1.textContent=v;
    kvEl.appendChild(k1); kvEl.appendChild(v1);
  }
  $("stepResult").style.display="block";
}

function buildCopyText(){
  const main=$("resultMain").textContent.trim();
  const kv=$("resultKV");
  const kids=[...kv.children];
  const out=["DEINE AUFGABE","",""+main];
  if(kids.length){
    out.push("");
    for(let i=0;i<kids.length;i+=2){
      out.push(`${kids[i].textContent.replace(":","").trim()}: ${kids[i+1].textContent.trim()}`);
    }
  }
  return out.join("\n");
}

function wire(){
  $("btnReload").onclick=async()=>{ try{await loadCSV(); resetAll(); showToast("Daten geladen.");}catch(e){setError(String(e.message||e));} };
  $("btnReset").onclick=resetAll;
  $("btnNew").onclick=()=>{
    selection=[]; bereich=null; $("inpDauer").value="";
    orgasmAllowed=null; orgasmRule=""; $("orgSub").style.display="none";
    $("orgNo").classList.remove("active"); $("orgYes").classList.remove("active");
    document.querySelectorAll('[data-orgsub]').forEach(b=>b.classList.remove("active"));
    $("stepResult").style.display="none";
    if(mode==="Kombination"){ currentType="Kleidung"; renderBereiche(); ["stepItem","stepParams","sep2","sep3"].forEach(id=>$(id).style.display="none"); }
    else { renderBereiche(); ["stepItem","stepParams","sep2","sep3"].forEach(id=>$(id).style.display="none"); }
    setError(null);
  };
  $("btnBuild").onclick=buildResult;

  $("btnCopy").onclick=async()=>{
    const txt=buildCopyText();
    try{ await navigator.clipboard.writeText(txt); showToast("Kopiert."); }
    catch{
      const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy"); ta.remove(); showToast("Kopiert.");
    }
  };

  $("orgNo").onclick=()=>{ orgasmAllowed=false; orgasmRule=""; $("orgNo").classList.add("active"); $("orgYes").classList.remove("active"); $("orgSub").style.display="none";
    document.querySelectorAll('[data-orgsub]').forEach(b=>b.classList.remove("active"));
  };
  $("orgYes").onclick=()=>{ orgasmAllowed=true; $("orgYes").classList.add("active"); $("orgNo").classList.remove("active"); $("orgSub").style.display="block"; };
  document.querySelectorAll('[data-orgsub]').forEach(b=> b.onclick=()=>{
    if(orgasmAllowed!==true) return;
    document.querySelectorAll('[data-orgsub]').forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); orgasmRule=b.getAttribute("data-orgsub");
  });
}

(async()=>{
  try{ await loadCSV(); wire(); resetAll(); }
  catch(e){ wire(); setError(String(e.message||e)); }
})();
</script>
</body>
</html>
